- name: Find or create server, ensure it's ON. ETA 3-{{wait_minutes}} minutes
  it_aruba_smart_vm:
    state: present
    user: "{{ aruba_account }}"
    password: "{{ aruba_password }}"
    dc: "{{ dc }}"
    name: "{{ vm_name }}"
    wait: true
    wait_time: "{{ wait_minutes * 60 }}"
    timeout: 12
  delegate_to: localhost
  register: t1

- name: Use default SSH port, if new server ...
  debug: msg="TODO port change ..."
  when: t1 is changed and ansible_port != 22

- name: Fill 'vm' details (no rebuild)
  loop:
    - {'k':'vm', 'v':"{{ vm|combine({'ip4':t1.srv.ip4, 'ip6':t1.srv.ip6|default(omit), 'server':t1.srv}, recursive=True) }}"}
    - {'k':'ansible_host', 'v':'{{ t1.srv.ip4 }}'}
    - {'k':'ansible_user', 'v':'root'}
    - {'k':'todo_port', 'v':'{{ ansible_port }}'}  # save inventory target
    - {'k':'ansible_port', 'v': 22}
  set_fact:
    "{{ item['k'] }}": "{{ item['v'] }}"
